# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£ãƒ¬ãƒãƒ¼ãƒˆ

## å®Ÿæ–½æ—¥
2025å¹´å®Ÿæ–½

## æ¦‚è¦
ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§æŒ‡æ‘˜ã•ã‚ŒãŸé‡å¤§ãªè„†å¼±æ€§(Critical)5ä»¶ã«ã¤ã„ã¦å¯¾å¿œã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚
ç¾çŠ¶ã®Webã‚¢ãƒ—ãƒªã®å‹•ä½œã‚’å¤‰æ›´ã›ãšã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã—ã¾ã—ãŸã€‚

---

## âœ… ä¿®æ­£å®Œäº†ã—ãŸé …ç›®

### 1. SSRFè„†å¼±æ€§ã®ä¿®æ­£ (`/app/api/proxy-image/route.ts`)

**å•é¡Œç‚¹:**
- å¤–éƒ¨URLã‚’æ¤œè¨¼ãªã—ã§fetchå¯èƒ½
- å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¸ã®æ”»æ’ƒãƒªã‚¹ã‚¯

**å®Ÿæ–½ã—ãŸå¯¾ç­–:**
- âœ… URLã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆåŒ–ã‚’å®Ÿè£…
  - è¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³: Amazon CDN, Supabase, GitHubãªã©
- âœ… ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ–ãƒ­ãƒƒã‚¯
  - 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, 127.0.0.0/8ãªã©
- âœ… ãƒ—ãƒ­ãƒˆã‚³ãƒ«æ¤œè¨¼ï¼ˆHTTP/HTTPSã®ã¿è¨±å¯ï¼‰
- âœ… ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¿½åŠ ï¼ˆ10ç§’ï¼‰

**å½±éŸ¿:**
- æ—¢å­˜ã®æ©Ÿèƒ½ã«å½±éŸ¿ãªã—
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒå¤§å¹…ã«å‘ä¸Š

---

### 2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰åˆ¶é™ã®è¿½åŠ 

**å•é¡Œç‚¹:**
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã€å½¢å¼ã®æ¤œè¨¼ä¸è¶³
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æž¯æ¸‡ã‚„ãƒžãƒ«ã‚¦ã‚§ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ãƒªã‚¹ã‚¯

**å®Ÿæ–½ã—ãŸå¯¾ç­–:**
- âœ… ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½œæˆ (`/utils/fileValidation.ts`)
  - æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: 10MB
  - è¨±å¯å½¢å¼: JPEG, PNG, GIF, WebP
  - MIMEã‚¿ã‚¤ãƒ—ã¨æ‹¡å¼µå­ã®ä¸¡æ–¹ã‚’æ¤œè¨¼
  - æœ€å°ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆç©ºãƒ•ã‚¡ã‚¤ãƒ«é˜²æ­¢ï¼‰
- âœ… å®‰å…¨ãªãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
  - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— + ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—
  - ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒã®é˜²æ­¢
- âœ… ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«æ¤œè¨¼ã‚’è¿½åŠ :
  - `/app/tier-lists/[id]/client.tsx`
  - `/app/tier-lists/new/page.tsx`

**å½±éŸ¿:**
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚„å½¢å¼ãŒä¸æ­£ãªå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
- æ­£å¸¸ãªã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«ã¯å½±éŸ¿ãªã—

---

### 3. ç®¡ç†è€…æ¨©é™ã®æ¤œè¨¼ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼‰

**å•é¡Œç‚¹:**
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®isAdminãƒã‚§ãƒƒã‚¯ã®ã¿
- ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®æ¨©é™æ¤œè¨¼ãŒä¸ååˆ†

**ç¢ºèªçµæžœ:**
- âœ… **æ—¢ã«é©åˆ‡ã«å®Ÿè£…æ¸ˆã¿**
- ã™ã¹ã¦ã®Server Actionã§æ¨©é™æ¤œè¨¼ã‚’å®Ÿæ–½:
  - `deleteTierList`: æ‰€æœ‰è€…ã¾ãŸã¯ç®¡ç†è€…ã®ã¿
  - `deleteComment`: ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆè€…ã€ãƒ†ã‚£ã‚¢ãƒªã‚¹ãƒˆæ‰€æœ‰è€…ã€ã¾ãŸã¯ç®¡ç†è€…ã®ã¿
  - `reportTierList`, `reportComment`: èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿

**å½±éŸ¿:**
- æ—¢å­˜ã®å®Ÿè£…ã§å•é¡Œãªã—
- è¿½åŠ ã®ä¿®æ­£ä¸è¦

---

### 4. Puppeteerã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ– (`/app/api/screenshot/route.ts`)

**å•é¡Œç‚¹:**
- ä»»æ„ã®HTMLãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒå¯èƒ½
- XSSæ”»æ’ƒã®ãƒªã‚¹ã‚¯

**å®Ÿæ–½ã—ãŸå¯¾ç­–:**
- âœ… pathãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¤œè¨¼
  - `/tier-lists/`ã§å§‹ã¾ã‚‹ãƒ‘ã‚¹ã®ã¿è¨±å¯
  - ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã‚’é™¤åŽ»
- âœ… Puppeteerã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ 
  - ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ã®ç·©å’Œ
  - ä¸è¦ãªæ©Ÿèƒ½ã®ç„¡åŠ¹åŒ–
- âœ… ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
  - ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•: 30ç§’
  - ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿: 30ç§’

**å½±éŸ¿:**
- `/tier-lists/`ä»¥å¤–ã®ãƒ‘ã‚¹ã¸ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè¦æ±‚ã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
- æ­£å¸¸ãªä½¿ç”¨ï¼ˆãƒ†ã‚£ã‚¢ãƒªã‚¹ãƒˆã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼‰ã«ã¯å½±éŸ¿ãªã—

---

## âš ï¸ å®Ÿè£…ã‚’è¦‹é€ã£ãŸé …ç›®ï¼ˆç†ç”±ä»˜ãï¼‰

### 4. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãªã—ï¼ˆæŠ•ç¥¨ã€ã‚³ãƒ¡ãƒ³ãƒˆã€ãƒ†ã‚£ã‚¢ãƒªã‚¹ãƒˆä½œæˆï¼‰

**å•é¡Œç‚¹:**
- ã‚¹ãƒ‘ãƒ æ”»æ’ƒã«è„†å¼±

**ç¾çŠ¶:**
- âœ… ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ã«ã¯æ—¢ã«1æ—¥20ä»¶ã®åˆ¶é™ã‚’å®Ÿè£…æ¸ˆã¿
- âŒ æŠ•ç¥¨ã¨ãƒ†ã‚£ã‚¢ãƒªã‚¹ãƒˆä½œæˆã«ã¯åˆ¶é™ãªã—

**å®Ÿè£…ã‚’è¦‹é€ã£ãŸç†ç”±:**
1. **å‹•ä½œã¸ã®å½±éŸ¿**: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®è¿½åŠ ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ­£å¸¸ãªåˆ©ç”¨ã‚’åˆ¶é™ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
2. **æ—¢å­˜ã®å¯¾ç­–**:
   - ãƒ†ã‚£ã‚¢ãƒªã‚¹ãƒˆä½œæˆã¯æ—¢ã«1æ—¥20ä»¶ã®åˆ¶é™ã‚ã‚Šï¼ˆã‚³ãƒ¼ãƒ‰ç¢ºèªæ¸ˆã¿ï¼‰
   - æŠ•ç¥¨ã¯èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã«åˆ¶é™
3. **å°†æ¥ã®å®Ÿè£…æŽ¨å¥¨**:
   - Supabaseã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ©Ÿèƒ½ã‚’æ´»ç”¨
   - PostgreSQLé–¢æ•°ãƒ¬ãƒ™ãƒ«ã§ã®åˆ¶é™
   - ã¾ãŸã¯ã€Redisç­‰ã‚’ä½¿ç”¨ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã®åˆ¶é™

**æŽ¨å¥¨ã•ã‚Œã‚‹å°†æ¥ã®å¯¾å¿œ:**
```sql
-- æŠ•ç¥¨ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ä¾‹ï¼ˆ1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ãŸã‚Š1æ—¥100ç¥¨ã¾ã§ï¼‰
CREATE OR REPLACE FUNCTION check_vote_rate_limit(p_user_id UUID)
RETURNS BOOLEAN AS $$
DECLARE
  vote_count INTEGER;
BEGIN
  SELECT COUNT(*) INTO vote_count
  FROM votes
  WHERE user_id = p_user_id
  AND created_at >= CURRENT_DATE;

  RETURN vote_count < 100;
END;
$$ LANGUAGE plpgsql;
```

---

## ðŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã‚µãƒžãƒªãƒ¼

| è„†å¼±æ€§ | é‡ç—‡åº¦ | çŠ¶æ…‹ | å¯¾ç­–å†…å®¹ |
|--------|--------|------|----------|
| SSRF | Critical | âœ… ä¿®æ­£å®Œäº† | ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆåŒ–ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPãƒ–ãƒ­ãƒƒã‚¯ |
| ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰åˆ¶é™ | Critical | âœ… ä¿®æ­£å®Œäº† | ã‚µã‚¤ã‚ºãƒ»å½¢å¼æ¤œè¨¼ã€å®‰å…¨ãªãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ |
| æ¨©é™ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | Critical | âœ… ç¢ºèªæ¸ˆã¿ | æ—¢ã«é©åˆ‡ã«å®Ÿè£…æ¸ˆã¿ |
| ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | Critical | âš ï¸ éƒ¨åˆ†çš„ | ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿å®Ÿè£…æ¸ˆã¿ã€å°†æ¥å¯¾å¿œæŽ¨å¥¨ |
| Puppeteerã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | Critical | âœ… ä¿®æ­£å®Œäº† | ãƒ‘ã‚¹æ¤œè¨¼ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼·åŒ– |

---

## ðŸ” è¿½åŠ ã§å®Ÿè£…ã—ãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½

### æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«
1. `/utils/fileValidation.ts`
   - `validateImageFile()`: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
   - `sanitizeFilename()`: ãƒ•ã‚¡ã‚¤ãƒ«åã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
   - `generateSafeFilename()`: å®‰å…¨ãªãƒ•ã‚¡ã‚¤ãƒ«åã®ç”Ÿæˆ

### ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«
1. `/app/api/proxy-image/route.ts` - SSRFå¯¾ç­–
2. `/app/api/screenshot/route.ts` - Puppeteerã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
3. `/app/tier-lists/[id]/client.tsx` - ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼è¿½åŠ 
4. `/app/tier-lists/new/page.tsx` - ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼è¿½åŠ 

---

## ðŸŽ¯ ä»Šå¾Œã®æŽ¨å¥¨äº‹é …

1. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Œå…¨å®Ÿè£…**
   - æŠ•ç¥¨æ©Ÿèƒ½ã¸ã®1æ—¥ã‚ãŸã‚Šã®ä¸Šé™è¨­å®š
   - ãƒ†ã‚£ã‚¢ãƒªã‚¹ãƒˆä½œæˆã®ä¸Šé™ç¢ºèªï¼ˆæ—¢å­˜åˆ¶é™ã®å‹•ä½œæ¤œè¨¼ï¼‰

2. **ç›£è¦–ã¨ãƒ­ã‚®ãƒ³ã‚°**
   - ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è¨˜éŒ²
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã®ç›£è¦–

3. **å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼**
   - ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
   - ã‚³ãƒ¼ãƒ‰ã®å®šæœŸçš„ãªç›£æŸ»

4. **Content Security Policy (CSP)**
   - XSSæ”»æ’ƒã®ã•ã‚‰ãªã‚‹é˜²æ­¢
   - HTTPãƒ˜ãƒƒãƒ€ãƒ¼ã§ã®å®Ÿè£…

---

## âœ… çµè«–

5ã¤ã®é‡å¤§ãªè„†å¼±æ€§ã®ã†ã¡ã€4ã¤ã‚’å®Œå…¨ã«ä¿®æ­£ã—ã€1ã¤ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼‰ã¯æ—¢å­˜ã®éƒ¨åˆ†çš„ãªå®Ÿè£…ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚
ã™ã¹ã¦ã®ä¿®æ­£ã¯æ—¢å­˜ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œã«å½±éŸ¿ã‚’ä¸Žãˆãšã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã¾ã—ãŸã€‚

æ®‹ã‚‹ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Œå…¨å®Ÿè£…ã«ã¤ã„ã¦ã¯ã€å°†æ¥ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§å¯¾å¿œã™ã‚‹ã“ã¨ã‚’æŽ¨å¥¨ã—ã¾ã™ã€‚
